<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aragon OTF Index Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg-primary: #F5F8FF;
    --bg-card: #FFFFFF;
    --bg-card-hover: #EEF2FB;
    --border: #D6DEF0;
    --text-primary: #0B1A3E;
    --text-secondary: #4A5B7A;
    --text-muted: #7889A5;
    --accent-blue: #3164FA;
    --accent-green: #00B37D;
    --accent-red: #E5484D;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-primary); color: var(--text-primary); min-height: 100vh;
  }

  /* HEADER */
  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 32px; border-bottom: 1px solid var(--border);
    background: #FFFFFF; box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  }
  .header-left { display: flex; align-items: center; gap: 16px; }
  .logo { width: 40px; height: 40px; border-radius: 10px; overflow: hidden; }
  .logo svg { width: 100%; height: 100%; }
  .header h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .status-badge {
    display: flex; align-items: center; gap: 6px; padding: 6px 14px;
    border-radius: 20px; font-size: 13px; font-weight: 500;
    background: rgba(0,179,125,0.08); color: #00855E;
    border: 1px solid rgba(0,179,125,0.2);
  }
  .status-dot {
    width: 8px; height: 8px; background: #00B37D;
    border-radius: 50%; animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

  /* LAYOUT */
  .container { max-width: 1400px; margin: 0 auto; padding: 24px 32px; }

  /* SUMMARY CARDS */
  .summary-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 24px; }
  .summary-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px; transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .summary-card:hover { background: var(--bg-card-hover); }
  .summary-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  .summary-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; }
  .summary-change {
    display: inline-flex; align-items: center; gap: 4px; margin-top: 6px;
    font-size: 13px; font-weight: 600; padding: 2px 8px; border-radius: 6px;
  }
  .positive { color: #00855E; background: rgba(0,179,125,0.08); }
  .negative { color: #CD2B31; background: rgba(229,72,77,0.08); }

  /* CONTROLS */
  .controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .time-range {
    display: flex; gap: 4px; background: var(--bg-card);
    border: 1px solid var(--border); border-radius: 10px; padding: 4px;
  }
  .time-btn {
    padding: 8px 16px; border: none; background: transparent;
    color: var(--text-muted); font-size: 13px; font-weight: 600;
    border-radius: 8px; cursor: pointer; transition: all 0.2s;
  }
  .time-btn:hover { color: var(--text-primary); }
  .time-btn.active { background: #3164FA; color: white; }
  .chart-toggles { display: flex; gap: 8px; flex-wrap: wrap; }
  .toggle-btn {
    display: flex; align-items: center; gap: 6px; padding: 6px 14px;
    border: 1px solid var(--border); background: var(--bg-card);
    color: var(--text-secondary); font-size: 12px; font-weight: 600;
    border-radius: 8px; cursor: pointer; transition: all 0.2s;
  }
  .toggle-btn.active { border-color: #3164FA; background: rgba(49,100,250,0.06); color: var(--text-primary); }
  .toggle-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* CHART SECTIONS */
  .chart-section {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 14px; padding: 24px; margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .chart-title { font-size: 16px; font-weight: 600; }
  .chart-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
  .chart-wrapper { position: relative; height: 400px; }

  /* TOKEN GRID */
  .token-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; margin-bottom: 24px; }
  .token-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .token-card:hover { background: var(--bg-card-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .token-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .token-info { display: flex; align-items: center; gap: 10px; }
  .token-icon {
    width: 36px; height: 36px; border-radius: 50%; display: flex;
    align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: white;
  }
  .token-name { font-size: 15px; font-weight: 600; }
  .token-fullname { font-size: 12px; color: var(--text-muted); }
  .token-price { font-size: 18px; font-weight: 700; text-align: right; }
  .token-metrics {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    padding-top: 12px; border-top: 1px solid var(--border);
  }
  .metric-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .metric-value { font-size: 14px; font-weight: 600; margin-top: 2px; }
  .mini-chart { height: 50px; margin: 8px 0; }
  .mini-chart canvas { width: 100% !important; height: 50px !important; }

  /* ALLOCATION */
  .allocation-section {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 14px; padding: 24px; margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .alloc-bar { display: flex; height: 32px; border-radius: 8px; overflow: hidden; margin: 16px 0; }
  .alloc-segment {
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: white;
    transition: all 0.3s; cursor: pointer; min-width: 40px;
  }
  .alloc-segment:hover { filter: brightness(1.1); }
  .alloc-legend { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 12px; }
  .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
  .legend-dot { width: 12px; height: 12px; border-radius: 3px; }
  .legend-pct { font-weight: 600; color: var(--text-primary); }

  /* TOKEN MANAGEMENT */
  .token-mgmt-section {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 14px; padding: 24px; margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .token-mgmt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .token-mgmt-title { font-size: 16px; font-weight: 600; }
  .token-mgmt-collapse {
    background: none; border: none; color: var(--text-muted);
    font-size: 20px; cursor: pointer; transition: all 0.2s; line-height: 1;
  }
  .token-mgmt-collapse:hover { color: var(--text-primary); }
  .token-mgmt-body { transition: all 0.3s; }
  .token-mgmt-body.collapsed { display: none; }
  .token-mgmt-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px;
  }
  .token-toggle-item {
    display: flex; align-items: center; gap: 10px; padding: 10px 12px;
    background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: 8px; transition: all 0.2s;
  }
  .token-toggle-item.inactive { opacity: 0.45; }
  .token-toggle-item:hover { border-color: #3164FA; }
  .toggle-switch {
    position: relative; width: 36px; height: 20px;
    background: #C4CEDF; border-radius: 10px;
    cursor: pointer; transition: all 0.2s; flex-shrink: 0;
  }
  .toggle-switch.active { background: #3164FA; }
  .toggle-switch::before {
    content: ''; position: absolute;
    width: 16px; height: 16px; background: white; border-radius: 50%;
    top: 2px; left: 2px; transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  }
  .toggle-switch.active::before { left: 18px; }
  .token-toggle-label { font-size: 13px; font-weight: 600; }
  .token-toggle-sub { font-size: 11px; color: var(--text-muted); }

  /* ADD TOKEN */
  .mgmt-actions { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
  .add-token-btn {
    padding: 8px 16px; background: #3164FA; color: white;
    border: none; border-radius: 8px; font-size: 13px;
    font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .add-token-btn:hover { background: #2652d8; }
  .add-token-form { display: none; margin-top: 16px; }
  .add-token-form.visible { display: block; }
  .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
  .form-group { flex: 1; display: flex; flex-direction: column; gap: 4px; }
  .form-group label {
    font-size: 11px; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .form-group input {
    padding: 8px 12px; background: #FFFFFF; border: 1px solid var(--border);
    border-radius: 6px; color: var(--text-primary); font-size: 13px; transition: all 0.2s;
  }
  .form-group input:focus { outline: none; border-color: #3164FA; box-shadow: 0 0 0 3px rgba(49,100,250,0.1); }
  .form-buttons { display: flex; gap: 8px; }
  .form-btn {
    padding: 8px 16px; border: none; border-radius: 6px;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .form-btn.submit { background: #3164FA; color: white; }
  .form-btn.submit:hover { background: #2652d8; }
  .form-btn.cancel { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
  .form-btn.cancel:hover { border-color: #3164FA; }
  .form-status { margin-top: 8px; font-size: 12px; padding: 8px; border-radius: 6px; display: none; }

  /* DATA NOTE */
  .data-note {
    background: rgba(49,100,250,0.05); border: 1px solid rgba(49,100,250,0.15);
    border-radius: 10px; padding: 12px 16px; margin-bottom: 24px;
    font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px;
  }
  .data-note strong { color: var(--text-primary); }

  /* FOOTER */
  .footer {
    text-align: center; padding: 24px; color: var(--text-muted);
    font-size: 13px; border-top: 1px solid var(--border); margin-top: 20px;
  }
  .footer a { color: #3164FA; text-decoration: none; }
  .footer a:hover { text-decoration: underline; }

  /* RESPONSIVE */
  @media (max-width: 900px) {
    .summary-row { grid-template-columns: repeat(2,1fr); }
    .token-grid { grid-template-columns: 1fr; }
    .controls-row { flex-direction: column; gap: 12px; }
    .form-row { flex-direction: column; }
    .token-mgmt-grid { grid-template-columns: repeat(2,1fr); }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">
      <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="40" height="40" rx="10" fill="#3164FA"/>
        <path d="M20 8L10 28h4.5l1.8-3.6h7.4L25.5 28H30L20 8zm0 8.4L23.2 22h-6.4L20 16.4z" fill="white"/>
      </svg>
    </div>
    <div>
      <h1 style="letter-spacing:-0.5px;">Aragon <span style="color:#3164FA;">OTF</span> Index</h1>
      <div style="font-size:13px;color:var(--text-muted);">Ownership Token Framework Dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <div class="status-badge" id="statusBadge">
      <div class="status-dot"></div>
      <span id="statusText">Loading...</span>
    </div>
    <div style="font-size:13px;color:var(--text-muted);" id="lastUpdated"></div>
  </div>
</div>

<div class="container">
  <div class="data-note" id="dataNote" style="display:none;">
    <strong>&#8505;</strong> <span id="dataNoteText"></span>
  </div>

  <!-- TOKEN MANAGEMENT -->
  <div class="token-mgmt-section">
    <div class="token-mgmt-header">
      <div class="token-mgmt-title">Index Tokens</div>
      <button class="token-mgmt-collapse" id="mgmtCollapseBtn">&#8722;</button>
    </div>
    <div class="token-mgmt-body" id="mgmtBody">
      <div class="token-mgmt-grid" id="tokenMgmtGrid"></div>
      <div class="mgmt-actions">
        <button class="add-token-btn" id="addTokenBtn">+ Add Token</button>
      </div>
      <div class="add-token-form" id="addTokenForm">
        <div class="form-row">
          <div class="form-group">
            <label>CoinGecko ID</label>
            <input type="text" id="newCgId" placeholder="e.g. compound-governance-token">
          </div>
          <div class="form-group">
            <label>Symbol</label>
            <input type="text" id="newSymbol" placeholder="e.g. COMP">
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="newName" placeholder="e.g. Compound">
          </div>
        </div>
        <div class="form-buttons">
          <button class="form-btn submit" id="submitTokenBtn">Add to Index</button>
          <button class="form-btn cancel" id="cancelTokenBtn">Cancel</button>
        </div>
        <div class="form-status" id="formStatus"></div>
      </div>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-row">
    <div class="summary-card">
      <div class="summary-label">OTF Index Value</div>
      <div class="summary-value" id="indexValue">--</div>
      <div class="summary-change positive" id="indexChange">--</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">vs NASDAQ (simulated)</div>
      <div class="summary-value" id="nasdaqValue">--</div>
      <div class="summary-change" id="nasdaqChange">--</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">vs Bitcoin</div>
      <div class="summary-value" id="btcValue">--</div>
      <div class="summary-change" id="btcChange">--</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">vs Ethereum</div>
      <div class="summary-value" id="ethValue">--</div>
      <div class="summary-change" id="ethChange">--</div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="controls-row">
    <div class="time-range">
      <button class="time-btn" data-range="7">7D</button>
      <button class="time-btn" data-range="30">1M</button>
      <button class="time-btn active" data-range="90">3M</button>
    </div>
    <div class="chart-toggles" id="chartToggles"></div>
  </div>

  <!-- MAIN CHART -->
  <div class="chart-section">
    <div class="chart-header">
      <div>
        <div class="chart-title">Normalized Performance (Indexed to 100)</div>
        <div class="chart-subtitle">OTF Index vs Benchmarks &mdash; rebased for easy comparison</div>
      </div>
    </div>
    <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>
  </div>

  <!-- ALLOCATION -->
  <div class="allocation-section">
    <div class="chart-header">
      <div>
        <div class="chart-title">Index Composition by Market Cap</div>
        <div class="chart-subtitle">Current weighting of each active token in the OTF Index</div>
      </div>
    </div>
    <div class="alloc-bar" id="allocBar"></div>
    <div class="alloc-legend" id="allocLegend"></div>
  </div>

  <!-- TOKEN CARDS -->
  <div class="token-grid" id="tokenGrid"></div>

  <!-- BAR CHART -->
  <div class="chart-section">
    <div class="chart-header">
      <div>
        <div class="chart-title">Individual Token Performance</div>
        <div class="chart-subtitle">Price change (%) over selected period</div>
      </div>
    </div>
    <div class="chart-wrapper"><canvas id="tokenBarChart"></canvas></div>
  </div>
</div>

<div class="footer">
  <a href="https://aragon.org" target="_blank" style="font-weight:600;">Aragon</a> &nbsp;&middot;&nbsp;
  <a href="https://otf.aragon.org" target="_blank">Ownership Token Framework</a>
  &nbsp;&middot;&nbsp; Market data via CoinGecko API
</div>

<script>
// ============================================================
// EMBEDDED DATA
// ============================================================
const EMBEDDED_DATA = {"generated":"2026-02-23T17:47:22.462946","days":91,"tokens":[{"symbol":"AAVE","name":"Aave","cgId":"aave","color":"#B6509E"},{"symbol":"AERO","name":"Aerodrome","cgId":"aerodrome-finance","color":"#3B82F6"},{"symbol":"CRV","name":"Curve DAO","cgId":"curve-dao-token","color":"#FACC15"},{"symbol":"LDO","name":"Lido DAO","cgId":"lido-dao","color":"#06B6D4"},{"symbol":"UNI","name":"Uniswap","cgId":"uniswap","color":"#EC4899"},{"symbol":"SKY","name":"Sky (MakerDAO)","cgId":"maker","color":"#8B5CF6"}],"benchmarks":[{"symbol":"BTC","name":"Bitcoin","cgId":"bitcoin","color":"#F7931A"},{"symbol":"ETH","name":"Ethereum","cgId":"ethereum","color":"#627EEA"}],"data":{"aave":{"prices":[[1764028800000,138.155731],[1764115200000,138.945812],[1764201600000,140.259485],[1764288000000,140.01562],[1764374400000,146.559912],[1764460800000,148.850708],[1764547200000,145.321539],[1764633600000,138.883919],[1764720000000,128.516033],[1764806400000,126.877927],[1764892800000,123.079389],[1764979200000,126.645258],[1765065600000,126.162685],[1765152000000,123.175996],[1765238400000,127.74471],[1765324800000,123.367762],[1765411200000,120.472086],[1765497600000,117.414969],[1765584000000,120.209294],[1765670400000,131.25128],[1765756800000,134.169152],[1765843200000,137.918547],[1765929600000,136.039588],[1766016000000,137.28156],[1766102400000,137.328408],[1766188800000,129.260757],[1766275200000,134.058378],[1766361600000,131.071147],[1766448000000,123.479721],[1766534400000,122.891822],[1766620800000,129.780375],[1766707200000,133.989503],[1766793600000,136.565814],[1766880000000,144.196292],[1766966400000,148.484537],[1767052800000,141.809417],[1767139200000,137.020271],[1767225600000,149.685078],[1767312000000,148.03785],[1767398400000,150.846581],[1767484800000,147.86001],[1767571200000,143.46933],[1767657600000,139.727733],[1767744000000,142.26235],[1767830400000,145.818613],[1767916800000,147.713585],[1768003200000,151.337967],[1768089600000,156.142259],[1768176000000,156.700748],[1768262400000,154.701875],[1768348800000,154.01349],[1768435200000,147.685366],[1768521600000,152.543396],[1768608000000,144.95238],[1768694400000,148.658905],[1768780800000,153.719327],[1768867200000,147.934499],[1768953600000,144.195362],[1769040000000,128.939807],[1769126400000,120.999589],[1769212800000,123.628913],[1769299200000,118.000226],[1769385600000,121.574816],[1769472000000,122.660301],[1769558400000,124.385395],[1769644800000,123.063777],[1769731200000,127.240091],[1769817600000,129.608601],[1769904000000,127.86004],[1769990400000,120.298165],[1770076800000,122.736735],[1770163200000,122.092008],[1770249600000,122.173354],[1770336000000,128.458347],[1770422400000,129.595677],[1770508800000,124.206247],[1770595200000,120.413874],[1770681600000,120.825724],[1770768000000,123.878442],[1770854400000,129.520157],[1770940800000,130.594126],[1771027200000,131.068887],[1771113600000,129.800357],[1771200000000,128.282537],[1771286400000,129.85948],[1771372800000,121.951799],[1771459200000,121.207462],[1771545600000,124.489681],[1771632000000,123.810885],[1771718400000,122.83078],[1771804800000,122.0]],"market_caps":[[1764028800000,1947769316.0],[1764115200000,1958908170.0],[1764201600000,1977428807.0],[1764288000000,1973990706.0],[1764374400000,2066254500.0],[1764460800000,2098550966.0],[1764547200000,2048795464.0],[1764633600000,1958035577.0],[1764720000000,1811865381.0],[1764806400000,1788770767.0],[1764892800000,1735217618.0],[1764979200000,1785490525.0],[1765065600000,1778687037.0],[1765152000000,1736579621.0],[1765238400000,1800990996.0],[1765324800000,1739283202.0],[1765411200000,1698458914.0],[1765497600000,1655358586.0],[1765584000000,1694753986.0],[1765670400000,1850427885.0],[1765756800000,1891565098.0],[1765843200000,1944425414.0],[1765929600000,1917935171.0],[1766016000000,1935444950.0],[1766102400000,1936105426.0],[1766188800000,1822364777.0],[1766275200000,1890003358.0],[1766361600000,1847888296.0],[1766448000000,1740861642.0],[1766534400000,1732573227.0],[1766620800000,1829690539.0],[1766707200000,1889032332.0],[1766793600000,1925354093.0],[1766880000000,2032931326.0],[1766966400000,2093388550.0],[1767052800000,1999280301.0],[1767139200000,1931761204.0],[1767225600000,2110314218.0],[1767312000000,2087091006.0],[1767398400000,2126689500.0],[1767484800000,2084583747.0],[1767571200000,2022682358.0],[1767657600000,1969931979.0],[1767744000000,2005665917.0],[1767830400000,2055803401.0],[1767916800000,2082519397.0],[1768003200000,2133617242.0],[1768089600000,2201349887.0],[1768176000000,2209223662.0],[1768262400000,2181042825.0],[1768348800000,2171337721.0],[1768435200000,2082121552.0],[1768521600000,2150611809.0],[1768608000000,2043590936.0],[1768694400000,2095846856.0],[1768780800000,2167190509.0],[1768867200000,2085633925.0],[1768953600000,2032918216.0],[1769040000000,1817839906.0],[1769126400000,1705895842.0],[1769212800000,1742965006.0],[1769299200000,1663609746.0],[1769385600000,1714005597.0],[1769472000000,1729309161.0],[1769558400000,1753630155.0],[1769644800000,1734997507.0],[1769731200000,1793876687.0],[1769817600000,1827268807.0],[1769904000000,1802616954.0],[1769990400000,1696006921.0],[1770076800000,1730386760.0],[1770163200000,1721297156.0],[1770249600000,1722444013.0],[1770336000000,1811052102.0],[1770422400000,1827086592.0],[1770508800000,1751104465.0],[1770595200000,1697638230.0],[1770681600000,1703444640.0],[1770768000000,1746482953.0],[1770854400000,1826021887.0],[1770940800000,1841163095.0],[1771027200000,1847856443.0],[1771113600000,1829972247.0],[1771200000000,1808573468.0],[1771286400000,1830805780.0],[1771372800000,1719320443.0],[1771459200000,1708826517.0],[1771545600000,1755100426.0],[1771632000000,1745530505.0],[1771718400000,1731712634.0],[1771804800000,1720000000.0]]},"aerodrome-finance":{"prices":[[1764028800000,0.135147],[1764115200000,0.138943],[1764201600000,0.130232],[1764288000000,0.134588],[1764374400000,0.141219],[1764460800000,0.135644],[1764547200000,0.137106],[1764633600000,0.139158],[1764720000000,0.124325],[1764806400000,0.120126],[1764892800000,0.128384],[1764979200000,0.132],[1765065600000,0.132544],[1765152000000,0.143938],[1765238400000,0.144473],[1765324800000,0.141474],[1765411200000,0.143119],[1765497600000,0.161176],[1765584000000,0.163463],[1765670400000,0.168948],[1765756800000,0.181356],[1765843200000,0.188427],[1765929600000,0.188856],[1766016000000,0.201132],[1766102400000,0.192077],[1766188800000,0.197167],[1766275200000,0.202692],[1766361600000,0.207652],[1766448000000,0.193109],[1766534400000,0.192018],[1766620800000,0.208126],[1766707200000,0.217791],[1766793600000,0.22055],[1766880000000,0.214655],[1766966400000,0.193804],[1767052800000,0.196948],[1767139200000,0.189137],[1767225600000,0.211495],[1767312000000,0.208428],[1767398400000,0.210247],[1767484800000,0.193871],[1767571200000,0.187221],[1767657600000,0.187244],[1767744000000,0.194686],[1767830400000,0.212016],[1767916800000,0.218902],[1768003200000,0.231256],[1768089600000,0.207239],[1768176000000,0.228324],[1768262400000,0.232066],[1768348800000,0.22967],[1768435200000,0.211021],[1768521600000,0.22768],[1768608000000,0.230833],[1768694400000,0.261766],[1768780800000,0.261031],[1768867200000,0.274112],[1768953600000,0.253395],[1769040000000,0.255979],[1769126400000,0.236146],[1769212800000,0.236823],[1769299200000,0.230937],[1769385600000,0.224062],[1769472000000,0.241697],[1769558400000,0.234768],[1769644800000,0.219202],[1769731200000,0.24123],[1769817600000,0.240473],[1769904000000,0.230699],[1769990400000,0.222395],[1770076800000,0.229145],[1770163200000,0.238232],[1770249600000,0.203557],[1770336000000,0.21136],[1770422400000,0.221079],[1770508800000,0.239296],[1770595200000,0.236409],[1770681600000,0.219694],[1770768000000,0.212229],[1770854400000,0.213058],[1770940800000,0.232784],[1771027200000,0.227073],[1771113600000,0.253002],[1771200000000,0.251789],[1771286400000,0.269569],[1771372800000,0.274924],[1771459200000,0.289001],[1771545600000,0.270604],[1771632000000,0.274236],[1771718400000,0.288113],[1771804800000,0.306]],"market_caps":[[1764028800000,124546907.0],[1764115200000,128045817.0],[1764201600000,120017402.0],[1764288000000,124032469.0],[1764374400000,130142952.0],[1764460800000,125004828.0],[1764547200000,126352891.0],[1764633600000,128243812.0],[1764720000000,114573767.0],[1764806400000,110704437.0],[1764892800000,118314690.0],[1764979200000,121646747.0],[1765065600000,122148266.0],[1765152000000,132648878.0],[1765238400000,133142070.0],[1765324800000,130378326.0],[1765411200000,131893607.0],[1765497600000,148534322.0],[1765584000000,150642166.0],[1765670400000,155697166.0],[1765756800000,167132250.0],[1765843200000,173648649.0],[1765929600000,174043484.0],[1766016000000,185356843.0],[1766102400000,177012586.0],[1766188800000,181703331.0],[1766275200000,186794518.0],[1766361600000,191365571.0],[1766448000000,177963342.0],[1766534400000,176958046.0],[1766620800000,191802367.0],[1766707200000,200709209.0],[1766793600000,203251968.0],[1766880000000,197819499.0],[1766966400000,178603296.0],[1767052800000,181500869.0],[1767139200000,174302274.0],[1767225600000,194907599.0],[1767312000000,192081086.0],[1767398400000,193757064.0],[1767484800000,178665175.0],[1767571200000,172537142.0],[1767657600000,172558583.0],[1767744000000,179416601.0],[1767830400000,195386970.0],[1767916800000,201733382.0],[1768003200000,213118645.0],[1768089600000,190985217.0],[1768176000000,210416675.0],[1768262400000,213865139.0],[1768348800000,211656263.0],[1768435200000,194470655.0],[1768521600000,209822435.0],[1768608000000,212728566.0],[1768694400000,241235446.0],[1768780800000,240557780.0],[1768867200000,252612587.0],[1768953600000,233520871.0],[1769040000000,235902019.0],[1769126400000,217624953.0],[1769212800000,218248793.0],[1769299200000,212824200.0],[1769385600000,206488626.0],[1769472000000,222740744.0],[1769558400000,216355145.0],[1769644800000,202009491.0],[1769731200000,222309946.0],[1769817600000,221612198.0],[1769904000000,212605199.0],[1769990400000,204952352.0],[1770076800000,211172891.0],[1770163200000,219547554.0],[1770249600000,187591891.0],[1770336000000,194782857.0],[1770422400000,203739454.0],[1770508800000,220527434.0],[1770595200000,217867469.0],[1770681600000,202462742.0],[1770768000000,195583839.0],[1770854400000,196348012.0],[1770940800000,214526623.0],[1771027200000,209263731.0],[1771113600000,233158731.0],[1771200000000,232040876.0],[1771286400000,248426789.0],[1771372800000,253361248.0],[1771459200000,266334134.0],[1771545600000,249380193.0],[1771632000000,252727274.0],[1771718400000,265515605.0],[1771804800000,282000000.0]]},"curve-dao-token":{"prices":[[1764028800000,0.222547],[1764115200000,0.220953],[1764201600000,0.219726],[1764288000000,0.198342],[1764374400000,0.175577],[1764460800000,0.163388],[1764547200000,0.169459],[1764633600000,0.17275],[1764720000000,0.16895],[1764806400000,0.15679],[1764892800000,0.168288],[1764979200000,0.187441],[1765065600000,0.184986],[1765152000000,0.187461],[1765238400000,0.192901],[1765324800000,0.192203],[1765411200000,0.223823],[1765497600000,0.22883],[1765584000000,0.239748],[1765670400000,0.257577],[1765756800000,0.248376],[1765843200000,0.238635],[1765929600000,0.233397],[1766016000000,0.244615],[1766102400000,0.244998],[1766188800000,0.263152],[1766275200000,0.268545],[1766361600000,0.263533],[1766448000000,0.232538],[1766534400000,0.239554],[1766620800000,0.225217],[1766707200000,0.216008],[1766793600000,0.203134],[1766880000000,0.197871],[1766966400000,0.203215],[1767052800000,0.207922],[1767139200000,0.207994],[1767225600000,0.198808],[1767312000000,0.186083],[1767398400000,0.188588],[1767484800000,0.193507],[1767571200000,0.213696],[1767657600000,0.228207],[1767744000000,0.227351],[1767830400000,0.204651],[1767916800000,0.209006],[1768003200000,0.221549],[1768089600000,0.216287],[1768176000000,0.198527],[1768262400000,0.195579],[1768348800000,0.207806],[1768435200000,0.214594],[1768521600000,0.219235],[1768608000000,0.212806],[1768694400000,0.19647],[1768780800000,0.187533],[1768867200000,0.216834],[1768953600000,0.219572],[1769040000000,0.208076],[1769126400000,0.225793],[1769212800000,0.223456],[1769299200000,0.245383],[1769385600000,0.219065],[1769472000000,0.220845],[1769558400000,0.217283],[1769644800000,0.217527],[1769731200000,0.20958],[1769817600000,0.204017],[1769904000000,0.207185],[1769990400000,0.20219],[1770076800000,0.22444],[1770163200000,0.223895],[1770249600000,0.244735],[1770336000000,0.24302],[1770422400000,0.238813],[1770508800000,0.246637],[1770595200000,0.223178],[1770681600000,0.248018],[1770768000000,0.247556],[1770854400000,0.251776],[1770940800000,0.2423],[1771027200000,0.254113],[1771113600000,0.258692],[1771200000000,0.250704],[1771286400000,0.256321],[1771372800000,0.262511],[1771459200000,0.252203],[1771545600000,0.251129],[1771632000000,0.256314],[1771718400000,0.236795],[1771804800000,0.234]],"market_caps":[[1764028800000,327162476.0],[1764115200000,324819940.0],[1764201600000,323015379.0],[1764288000000,291580056.0],[1764374400000,258113057.0],[1764460800000,240194241.0],[1764547200000,249119658.0],[1764633600000,253956771.0],[1764720000000,248371674.0],[1764806400000,230495375.0],[1764892800000,247397656.0],[1764979200000,275553629.0],[1765065600000,271945452.0],[1765152000000,275583967.0],[1765238400000,283580720.0],[1765324800000,282554989.0],[1765411200000,329039083.0],[1765497600000,336399653.0],[1765584000000,352449636.0],[1765670400000,378660184.0],[1765756800000,365134574.0],[1765843200000,350813923.0],[1765929600000,343113486.0],[1766016000000,359604961.0],[1766102400000,360167736.0],[1766188800000,386856395.0],[1766275200000,394784598.0],[1766361600000,387416377.0],[1766448000000,341850766.0],[1766534400000,352164560.0],[1766620800000,331087962.0],[1766707200000,317550076.0],[1766793600000,298625009.0],[1766880000000,290887507.0],[1766966400000,298744149.0],[1767052800000,305663029.0],[1767139200000,305768725.0],[1767225600000,292265323.0],[1767312000000,273557337.0],[1767398400000,277240818.0],[1767484800000,284472460.0],[1767571200000,314150734.0],[1767657600000,335484209.0],[1767744000000,334225279.0],[1767830400000,300853908.0],[1767916800000,307257021.0],[1768003200000,325695864.0],[1768089600000,317960102.0],[1768176000000,291851591.0],[1768262400000,287517414.0],[1768348800000,305492524.0],[1768435200000,315472049.0],[1768521600000,322293949.0],[1768608000000,312842525.0],[1768694400000,288827172.0],[1768780800000,275689447.0],[1768867200000,318765125.0],[1768953600000,322790104.0],[1769040000000,305890232.0],[1769126400000,331935340.0],[1769212800000,328499861.0],[1769299200000,360733379.0],[1769385600000,322044221.0],[1769472000000,324660695.0],[1769558400000,319424380.0],[1769644800000,319783463.0],[1769731200000,308100366.0],[1769817600000,299922651.0],[1769904000000,304579130.0],[1769990400000,297236520.0],[1770076800000,329946562.0],[1770163200000,329145235.0],[1770249600000,359781892.0],[1770336000000,357259865.0],[1770422400000,351074893.0],[1770508800000,362577580.0],[1770595200000,328090959.0],[1770681600000,364607652.0],[1770768000000,363928675.0],[1770854400000,370131658.0],[1770940800000,356202371.0],[1771027200000,373568393.0],[1771113600000,380299202.0],[1771200000000,368556757.0],[1771286400000,376814147.0],[1771372800000,385913184.0],[1771459200000,370760633.0],[1771545600000,369180921.0],[1771632000000,376803589.0],[1771718400000,348109519.0],[1771804800000,344000000.0]]},"lido-dao":{"prices":[[1764028800000,0.356521],[1764115200000,0.367437],[1764201600000,0.381576],[1764288000000,0.376936],[1764374400000,0.390201],[1764460800000,0.386768],[1764547200000,0.397528],[1764633600000,0.392669],[1764720000000,0.400511],[1764806400000,0.396376],[1764892800000,0.419583],[1764979200000,0.401869],[1765065600000,0.38787],[1765152000000,0.383466],[1765238400000,0.397493],[1765324800000,0.43132],[1765411200000,0.409673],[1765497600000,0.410432],[1765584000000,0.422497],[1765670400000,0.406659],[1765756800000,0.409547],[1765843200000,0.412631],[1765929600000,0.394332],[1766016000000,0.428919],[1766102400000,0.434439],[1766188800000,0.402219],[1766275200000,0.428635],[1766361600000,0.417379],[1766448000000,0.418449],[1766534400000,0.401897],[1766620800000,0.406588],[1766707200000,0.366923],[1766793600000,0.377636],[1766880000000,0.414454],[1766966400000,0.389562],[1767052800000,0.393328],[1767139200000,0.423882],[1767225600000,0.381996],[1767312000000,0.395547],[1767398400000,0.353708],[1767484800000,0.384536],[1767571200000,0.419974],[1767657600000,0.446038],[1767744000000,0.461931],[1767830400000,0.433792],[1767916800000,0.388262],[1768003200000,0.394679],[1768089600000,0.402686],[1768176000000,0.401506],[1768262400000,0.392122],[1768348800000,0.401785],[1768435200000,0.362356],[1768521600000,0.371548],[1768608000000,0.407577],[1768694400000,0.390735],[1768780800000,0.397744],[1768867200000,0.402755],[1768953600000,0.378602],[1769040000000,0.390148],[1769126400000,0.37507],[1769212800000,0.393336],[1769299200000,0.410711],[1769385600000,0.447361],[1769472000000,0.447387],[1769558400000,0.443243],[1769644800000,0.413883],[1769731200000,0.411198],[1769817600000,0.397804],[1769904000000,0.386514],[1769990400000,0.386094],[1770076800000,0.418079],[1770163200000,0.424597],[1770249600000,0.408169],[1770336000000,0.399551],[1770422400000,0.403344],[1770508800000,0.405287],[1770595200000,0.360184],[1770681600000,0.348571],[1770768000000,0.338453],[1770854400000,0.326254],[1770940800000,0.323051],[1771027200000,0.343876],[1771113600000,0.339565],[1771200000000,0.351973],[1771286400000,0.368392],[1771372800000,0.374103],[1771459200000,0.379138],[1771545600000,0.33965],[1771632000000,0.317841],[1771718400000,0.304655],[1771804800000,0.309]],"market_caps":[[1764028800000,303446340.0],[1764115200000,312737626.0],[1764201600000,324771571.0],[1764288000000,320822172.0],[1764374400000,332112768.0],[1764460800000,329190522.0],[1764547200000,338348758.0],[1764633600000,334213177.0],[1764720000000,340888053.0],[1764806400000,337368755.0],[1764892800000,357120700.0],[1764979200000,342043731.0],[1765065600000,330129069.0],[1765152000000,326380339.0],[1765238400000,338319576.0],[1765324800000,367110845.0],[1765411200000,348686148.0],[1765497600000,349332094.0],[1765584000000,359600600.0],[1765670400000,346120932.0],[1765756800000,348578419.0],[1765843200000,351204063.0],[1765929600000,335628860.0],[1766016000000,365066671.0],[1766102400000,369765174.0],[1766188800000,342341791.0],[1766275200000,364824984.0],[1766361600000,355244778.0],[1766448000000,356155900.0],[1766534400000,342067443.0],[1766620800000,346060535.0],[1766707200000,312299754.0],[1766793600000,321418452.0],[1766880000000,352755159.0],[1766966400000,331569235.0],[1767052800000,334774670.0],[1767139200000,360779979.0],[1767225600000,325129682.0],[1767312000000,336663367.0],[1767398400000,301052183.0],[1767484800000,327291413.0],[1767571200000,357453819.0],[1767657600000,379637479.0],[1767744000000,393164421.0],[1767830400000,369214422.0],[1767916800000,330462574.0],[1768003200000,335924008.0],[1768089600000,342739315.0],[1768176000000,341734681.0],[1768262400000,333748140.0],[1768348800000,341972693.0],[1768435200000,308412719.0],[1768521600000,316236744.0],[1768608000000,346901901.0],[1768694400000,332567751.0],[1768780800000,338532974.0],[1768867200000,342797824.0],[1768953600000,322240539.0],[1769040000000,332067611.0],[1769126400000,319234052.0],[1769212800000,334781217.0],[1769299200000,349569738.0],[1769385600000,380763221.0],[1769472000000,380785730.0],[1769558400000,377258498.0],[1769644800000,352269545.0],[1769731200000,349984083.0],[1769817600000,338584275.0],[1769904000000,328974684.0],[1769990400000,328617009.0],[1770076800000,355840802.0],[1770163200000,361388428.0],[1770249600000,347405561.0],[1770336000000,340070686.0],[1770422400000,343299412.0],[1770508800000,344952846.0],[1770595200000,306564135.0],[1770681600000,296680329.0],[1770768000000,288068019.0],[1770854400000,277685523.0],[1770940800000,274959111.0],[1771027200000,292683813.0],[1771113600000,289014794.0],[1771200000000,299575332.0],[1771286400000,313550426.0],[1771372800000,318411304.0],[1771459200000,322696919.0],[1771545600000,289087308.0],[1771632000000,270524467.0],[1771718400000,259302101.0],[1771804800000,263000000.0]]},"uniswap":{"prices":[[1764028800000,5.770796],[1764115200000,5.510657],[1764201600000,5.639816],[1764288000000,5.371696],[1764374400000,5.317451],[1764460800000,5.127435],[1764547200000,5.341562],[1764633600000,5.040989],[1764720000000,4.628468],[1764806400000,4.145891],[1764892800000,3.897828],[1764979200000,3.969668],[1765065600000,3.690804],[1765152000000,3.973842],[1765238400000,3.971423],[1765324800000,3.96171],[1765411200000,3.907202],[1765497600000,4.254877],[1765584000000,4.443023],[1765670400000,4.554668],[1765756800000,4.700415],[1765843200000,4.373353],[1765929600000,4.370797],[1766016000000,4.351109],[1766102400000,4.336543],[1766188800000,4.336789],[1766275200000,4.20279],[1766361600000,4.442485],[1766448000000,4.531894],[1766534400000,4.658216],[1766620800000,4.427941],[1766707200000,4.367722],[1766793600000,4.403199],[1766880000000,4.598674],[1766966400000,4.600843],[1767052800000,4.635096],[1767139200000,4.643417],[1767225600000,4.521565],[1767312000000,4.456884],[1767398400000,4.182149],[1767484800000,4.294256],[1767571200000,4.174872],[1767657600000,4.069451],[1767744000000,4.164911],[1767830400000,4.333494],[1767916800000,4.227839],[1768003200000,4.253022],[1768089600000,4.310142],[1768176000000,3.940154],[1768262400000,3.975063],[1768348800000,3.868033],[1768435200000,3.72122],[1768521600000,3.623669],[1768608000000,3.701456],[1768694400000,3.521356],[1768780800000,3.51813],[1768867200000,3.630341],[1768953600000,3.800398],[1769040000000,3.736318],[1769126400000,3.614087],[1769212800000,3.774225],[1769299200000,3.687345],[1769385600000,3.890104],[1769472000000,4.00278],[1769558400000,4.115319],[1769644800000,4.190522],[1769731200000,4.071564],[1769817600000,4.222919],[1769904000000,4.155707],[1769990400000,4.013594],[1770076800000,3.98395],[1770163200000,4.264688],[1770249600000,4.130989],[1770336000000,3.999884],[1770422400000,3.922378],[1770508800000,3.963476],[1770595200000,3.919799],[1770681600000,3.682504],[1770768000000,3.667722],[1770854400000,3.608092],[1770940800000,3.381068],[1771027200000,3.380963],[1771113600000,3.685835],[1771200000000,3.913635],[1771286400000,3.902426],[1771372800000,4.033672],[1771459200000,3.870794],[1771545600000,3.752234],[1771632000000,3.60738],[1771718400000,3.47971],[1771804800000,3.46]],"market_caps":[[1764028800000,3652613504.0],[1764115200000,3487959308.0],[1764201600000,3569710165.0],[1764288000000,3400004322.0],[1764374400000,3365670037.0],[1764460800000,3245399782.0],[1764547200000,3380930979.0],[1764633600000,3190683484.0],[1764720000000,2929579288.0],[1764806400000,2624133057.0],[1764892800000,2467122635.0],[1764979200000,2512593479.0],[1765065600000,2336086830.0],[1765152000000,2515235297.0],[1765238400000,2513704380.0],[1765324800000,2507556546.0],[1765411200000,2473055858.0],[1765497600000,2693115725.0],[1765584000000,2812202437.0],[1765670400000,2882868120.0],[1765756800000,2975118232.0],[1765843200000,2768104806.0],[1765929600000,2766487149.0],[1766016000000,2754025689.0],[1766102400000,2744806015.0],[1766188800000,2744961705.0],[1766275200000,2660147348.0],[1766361600000,2811861887.0],[1766448000000,2868453031.0],[1766534400000,2948408267.0],[1766620800000,2802656074.0],[1766707200000,2764540820.0],[1766793600000,2786995862.0],[1766880000000,2910721542.0],[1766966400000,2912093995.0],[1767052800000,2933774713.0],[1767139200000,2939041130.0],[1767225600000,2861915221.0],[1767312000000,2820975818.0],[1767398400000,2647082568.0],[1767484800000,2718040419.0],[1767571200000,2642477089.0],[1767657600000,2575750933.0],[1767744000000,2636171912.0],[1767830400000,2742876484.0],[1767916800000,2676002259.0],[1768003200000,2691941558.0],[1768089600000,2728095749.0],[1768176000000,2493912507.0],[1768262400000,2516007977.0],[1768348800000,2448263531.0],[1768435200000,2355338726.0],[1768521600000,2293593738.0],[1768608000000,2342828923.0],[1768694400000,2228834943.0],[1768780800000,2226793112.0],[1768867200000,2297816714.0],[1768953600000,2405454461.0],[1769040000000,2364894662.0],[1769126400000,2287529158.0],[1769212800000,2388888006.0],[1769299200000,2333897526.0],[1769385600000,2462233386.0],[1769472000000,2533551270.0],[1769558400000,2604783072.0],[1769644800000,2652382598.0],[1769731200000,2577088029.0],[1769817600000,2672888051.0],[1769904000000,2630346537.0],[1769990400000,2540396038.0],[1770076800000,2521633071.0],[1770163200000,2699325870.0],[1770249600000,2614701274.0],[1770336000000,2531718403.0],[1770422400000,2482661007.0],[1770508800000,2508673963.0],[1770595200000,2481029050.0],[1770681600000,2330833273.0],[1770768000000,2321477456.0],[1770854400000,2283734548.0],[1770940800000,2140040399.0],[1771027200000,2139973841.0],[1771113600000,2332942115.0],[1771200000000,2477127361.0],[1771286400000,2470032639.0],[1771372800000,2553104423.0],[1771459200000,2450011328.0],[1771545600000,2374968773.0],[1771632000000,2283283579.0],[1771718400000,2202475686.0],[1771804800000,2190000000.0]]},"maker":{"prices":[[1764028800000,1831.093022],[1764115200000,1798.569647],[1764201600000,1797.265695],[1764288000000,1871.147365],[1764374400000,1914.431869],[1764460800000,1804.83845],[1764547200000,1770.277598],[1764633600000,1752.39592],[1764720000000,1711.938653],[1764806400000,1774.607159],[1764892800000,1838.567078],[1764979200000,1842.373096],[1765065600000,1878.227558],[1765152000000,1863.640277],[1765238400000,1904.043576],[1765324800000,1812.049387],[1765411200000,1749.641132],[1765497600000,1662.337031],[1765584000000,1601.95817],[1765670400000,1601.127054],[1765756800000,1652.338932],[1765843200000,1660.261409],[1765929600000,1731.25307],[1766016000000,1755.435268],[1766102400000,1754.195038],[1766188800000,1637.375229],[1766275200000,1637.923246],[1766361600000,1581.272159],[1766448000000,1584.291016],[1766534400000,1631.408234],[1766620800000,1642.712269],[1766707200000,1659.332388],[1766793600000,1712.397012],[1766880000000,1761.769486],[1766966400000,1806.045809],[1767052800000,1820.512568],[1767139200000,1909.702181],[1767225600000,1961.979224],[1767312000000,1891.38264],[1767398400000,1879.682081],[1767484800000,1867.678979],[1767571200000,1873.695375],[1767657600000,1839.20564],[1767744000000,1860.15539],[1767830400000,1826.977686],[1767916800000,1908.703251],[1768003200000,1855.859556],[1768089600000,1861.116709],[1768176000000,1845.643681],[1768262400000,1889.412665],[1768348800000,1897.035166],[1768435200000,1870.282593],[1768521600000,1784.051635],[1768608000000,1833.627088],[1768694400000,1739.718499],[1768780800000,1618.79656],[1768867200000,1702.904762],[1768953600000,1782.094355],[1769040000000,1718.920021],[1769126400000,1722.527971],[1769212800000,1716.876483],[1769299200000,1635.828795],[1769385600000,1695.618893],[1769472000000,1648.63841],[1769558400000,1570.958159],[1769644800000,1627.530787],[1769731200000,1518.394519],[1769817600000,1535.900053],[1769904000000,1503.542343],[1769990400000,1538.89337],[1770076800000,1481.793814],[1770163200000,1462.859509],[1770249600000,1457.083173],[1770336000000,1534.288684],[1770422400000,1543.228392],[1770508800000,1535.098386],[1770595200000,1505.935546],[1770681600000,1551.017614],[1770768000000,1543.760889],[1770854400000,1563.725971],[1770940800000,1602.625966],[1771027200000,1569.696108],[1771113600000,1538.126796],[1771200000000,1472.334653],[1771286400000,1477.80328],[1771372800000,1550.753787],[1771459200000,1551.319646],[1771545600000,1557.208357],[1771632000000,1514.744904],[1771718400000,1461.336984],[1771804800000,1528.0]],"market_caps":[[1764028800000,1097697126.0],[1764115200000,1078200128.0],[1764201600000,1077418440.0],[1764288000000,1121708761.0],[1764374400000,1147656801.0],[1764460800000,1081958129.0],[1764547200000,1061239712.0],[1764633600000,1050520067.0],[1764720000000,1026266889.0],[1764806400000,1063835182.0],[1764892800000,1102177646.0],[1764979200000,1104459264.0],[1765065600000,1125953170.0],[1765152000000,1117208439.0],[1765238400000,1141429264.0],[1765324800000,1086280915.0],[1765411200000,1048868637.0],[1765497600000,996531885.0],[1765584000000,960336181.0],[1765670400000,959837946.0],[1765756800000,990538260.0],[1765843200000,995287599.0],[1765929600000,1037845427.0],[1766016000000,1052342085.0],[1766102400000,1051598596.0],[1766188800000,981567873.0],[1766275200000,981896396.0],[1766361600000,947935404.0],[1766448000000,949745138.0],[1766534400000,977990800.0],[1766620800000,984767303.0],[1766707200000,994730672.0],[1766793600000,1026541664.0],[1766880000000,1056139299.0],[1766966400000,1082681912.0],[1767052800000,1091354393.0],[1767139200000,1144821465.0],[1767225600000,1176160320.0],[1767312000000,1133839331.0],[1767398400000,1126825122.0],[1767484800000,1119629545.0],[1767571200000,1123236233.0],[1767657600000,1102560449.0],[1767744000000,1115119331.0],[1767830400000,1095230079.0],[1767916800000,1144222629.0],[1768003200000,1112544080.0],[1768089600000,1115695619.0],[1768176000000,1106419903.0],[1768262400000,1132658378.0],[1768348800000,1137227888.0],[1768435200000,1121190350.0],[1768521600000,1069496922.0],[1768608000000,1099216239.0],[1768694400000,1042920252.0],[1768780800000,970430398.0],[1768867200000,1020851284.0],[1768953600000,1068323579.0],[1769040000000,1030452055.0],[1769126400000,1032614935.0],[1769212800000,1029227002.0],[1769299200000,980640822.0],[1769385600000,1016483578.0],[1769472000000,988319885.0],[1769558400000,941752404.0],[1769644800000,975666362.0],[1769731200000,910241741.0],[1769817600000,920735896.0],[1769904000000,901338211.0],[1769990400000,922530319.0],[1770076800000,888300480.0],[1770163200000,876949811.0],[1770249600000,873487033.0],[1770336000000,919769918.0],[1770422400000,925129062.0],[1770508800000,920255315.0],[1770595200000,902772880.0],[1770681600000,929798517.0],[1770768000000,925448282.0],[1770854400000,937416878.0],[1770940800000,960736508.0],[1771027200000,940995834.0],[1771113600000,922070776.0],[1771200000000,882629936.0],[1771286400000,885908249.0],[1771372800000,929640359.0],[1771459200000,929979578.0],[1771545600000,933509722.0],[1771632000000,908053882.0],[1771718400000,876037092.0],[1771804800000,916000000.0]]},"bitcoin":{"prices":[[1764028800000,94038.839736],[1764115200000,94224.985514],[1764201600000,90272.23945],[1764288000000,91538.674249],[1764374400000,91988.905792],[1764460800000,90934.031067],[1764547200000,86996.554381],[1764633600000,87849.448753],[1764720000000,88064.954946],[1764806400000,89005.24144],[1764892800000,88817.27927],[1764979200000,86951.405781],[1765065600000,86273.075835],[1765152000000,84168.03831],[1765238400000,83951.54321],[1765324800000,83357.009607],[1765411200000,81037.485775],[1765497600000,79750.690334],[1765584000000,77623.617441],[1765670400000,75918.775792],[1765756800000,75186.485003],[1765843200000,75770.436224],[1765929600000,76736.988555],[1766016000000,76779.750709],[1766102400000,73225.402282],[1766188800000,70622.618914],[1766275200000,69553.887246],[1766361600000,69624.86629],[1766448000000,66560.336808],[1766534400000,67787.699835],[1766620800000,69974.536124],[1766707200000,70105.776223],[1766793600000,74219.619226],[1766880000000,72648.711544],[1766966400000,72062.430537],[1767052800000,75048.3833],[1767139200000,72819.82244],[1767225600000,75837.651693],[1767312000000,76485.260442],[1767398400000,75356.491596],[1767484800000,75913.107296],[1767571200000,76076.918388],[1767657600000,75592.177569],[1767744000000,76011.61545],[1767830400000,73314.517764],[1767916800000,72240.042261],[1768003200000,73089.354885],[1768089600000,72263.116331],[1768176000000,72492.261667],[1768262400000,75864.480364],[1768348800000,75285.408323],[1768435200000,76336.086824],[1768521600000,73340.641217],[1768608000000,72693.283845],[1768694400000,70518.67389],[1768780800000,73556.012732],[1768867200000,72988.340424],[1768953600000,68132.451745],[1769040000000,67546.988178],[1769126400000,65670.628763],[1769212800000,65073.975222],[1769299200000,62644.045808],[1769385600000,60581.35615],[1769472000000,62833.026441],[1769558400000,65858.010492],[1769644800000,63245.384123],[1769731200000,64840.187176],[1769817600000,64655.050798],[1769904000000,63049.966306],[1769990400000,63583.603301],[1770076800000,62079.167426],[1770163200000,60551.67746],[1770249600000,60715.253531],[1770336000000,63599.478927],[1770422400000,66780.796674],[1770508800000,64820.219467],[1770595200000,65984.011947],[1770681600000,67547.833278],[1770768000000,69743.050814],[1770854400000,67322.618363],[1770940800000,66326.041797],[1771027200000,65549.987373],[1771113600000,65276.814371],[1771200000000,64720.072913],[1771286400000,66161.284445],[1771372800000,68330.670835],[1771459200000,67218.833356],[1771545600000,67325.180229],[1771632000000,67489.243607],[1771718400000,63397.771841],[1771804800000,65000.0]],"market_caps":[[1764028800000,1866309280917.0],[1764115200000,1870003558665.0],[1764201600000,1791556752171.0],[1764288000000,1816690612010.0],[1764374400000,1825625976478.0],[1764460800000,1804690770399.0],[1764547200000,1726547002339.0],[1764633600000,1743473675260.0],[1764720000000,1747750644316.0],[1764806400000,1766411714735.0],[1764892800000,1762681388580.0],[1764979200000,1725650976273.0],[1765065600000,1712188735795.0],[1765152000000,1670411837237.0],[1765238400000,1666115242163.0],[1765324800000,1654316036807.0],[1765411200000,1608282409998.0],[1765497600000,1582744469708.0],[1765584000000,1540530253829.0],[1765670400000,1506695704190.0],[1765756800000,1492162548524.0],[1765843200000,1503751734300.0],[1765929600000,1522934080548.0],[1766016000000,1523782744844.0],[1766102400000,1453242599133.0],[1766188800000,1401587359978.0],[1766275200000,1380377146881.0],[1766361600000,1381785807909.0],[1766448000000,1320966684341.0],[1766534400000,1345325119811.0],[1766620800000,1388725409230.0],[1766707200000,1391330020434.0],[1766793600000,1472973981565.0],[1766880000000,1441797506029.0],[1766966400000,1430162082974.0],[1767052800000,1489421760869.0],[1767139200000,1445193399191.0],[1767225600000,1505085702825.0],[1767312000000,1517938245692.0],[1767398400000,1495536525524.0],[1767484800000,1506583206339.0],[1767571200000,1509834226471.0],[1767657600000,1500213985601.0],[1767744000000,1508538214309.0],[1767830400000,1455011198706.0],[1767916800000,1433686992565.0],[1768003200000,1450542581569.0],[1768089600000,1434144924107.0],[1768176000000,1438692577707.0],[1768262400000,1505618148757.0],[1768348800000,1494125795945.0],[1768435200000,1514977723113.0],[1768521600000,1455529648778.0],[1768608000000,1442682094776.0],[1768694400000,1399524451040.0],[1768780800000,1459803944980.0],[1768867200000,1448537833030.0],[1768953600000,1352167119239.0],[1769040000000,1340547919230.0],[1769126400000,1303309401602.0],[1769212800000,1291468123640.0],[1769299200000,1243243370648.0],[1769385600000,1202306914370.0],[1769472000000,1246993909364.0],[1769558400000,1307028208227.0],[1769644800000,1255177623365.0],[1769731200000,1286828330106.0],[1769817600000,1283154085069.0],[1769904000000,1251299331304.0],[1769990400000,1261889973196.0],[1770076800000,1232032707377.0],[1770163200000,1201717906509.0],[1770249600000,1204964262382.0],[1770336000000,1262205043323.0],[1770422400000,1325341964765.0],[1770508800000,1286432047885.0],[1770595200000,1309528852487.0],[1770681600000,1340564691211.0],[1770768000000,1384131316147.0],[1770854400000,1336095041351.0],[1770940800000,1316316829505.0],[1771027200000,1300915134009.0],[1771113600000,1295493700603.0],[1771200000000,1284444523970.0],[1771286400000,1313047029753.0],[1771372800000,1356101005801.0],[1771459200000,1334035308144.0],[1771545600000,1336145884541.0],[1771632000000,1339401911589.0],[1771718400000,1258201933453.0],[1771804800000,1290000000000.0]]},"ethereum":{"prices":[[1764028800000,3928.369101],[1764115200000,3996.97414],[1764201600000,3945.026348],[1764288000000,3964.390875],[1764374400000,4075.053559],[1764460800000,4064.779808],[1764547200000,4002.682572],[1764633600000,3940.811389],[1764720000000,4059.34454],[1764806400000,3872.111992],[1764892800000,3792.7737],[1764979200000,3838.316509],[1765065600000,3812.546056],[1765152000000,3652.675231],[1765238400000,3640.78589],[1765324800000,3710.750123],[1765411200000,3747.730347],[1765497600000,3698.128616],[1765584000000,3706.81143],[1765670400000,3501.123169],[1765756800000,3352.883432],[1765843200000,3399.999606],[1765929600000,3275.764805],[1766016000000,3071.748737],[1766102400000,2948.862551],[1766188800000,2819.585217],[1766275200000,2839.02293],[1766361600000,2651.9596],[1766448000000,2574.779093],[1766534400000,2485.754047],[1766620800000,2454.413165],[1766707200000,2561.636686],[1766793600000,2567.934143],[1766880000000,2524.695392],[1766966400000,2464.878467],[1767052800000,2458.844199],[1767139200000,2532.178127],[1767225600000,2551.21839],[1767312000000,2557.491881],[1767398400000,2511.886504],[1767484800000,2480.847511],[1767571200000,2522.855604],[1767657600000,2528.946543],[1767744000000,2337.474913],[1767830400000,2319.865097],[1767916800000,2247.111658],[1768003200000,2173.376138],[1768089600000,2163.371907],[1768176000000,2212.178415],[1768262400000,2251.902723],[1768348800000,2119.727005],[1768435200000,2103.5311],[1768521600000,2028.855543],[1768608000000,1980.654355],[1768694400000,1985.472929],[1768780800000,1898.519966],[1768867200000,1899.872357],[1768953600000,1893.079319],[1769040000000,1915.897331],[1769126400000,1891.33333],[1769212800000,1841.084417],[1769299200000,1845.938169],[1769385600000,1870.111768],[1769472000000,1899.984485],[1769558400000,1966.05658],[1769644800000,1906.495844],[1769731200000,1926.113319],[1769817600000,1896.49956],[1769904000000,1951.263097],[1769990400000,1962.827685],[1770076800000,1964.604798],[1770163200000,1970.848674],[1770249600000,1902.394332],[1770336000000,1843.212362],[1770422400000,1888.030192],[1770508800000,1833.956305],[1770595200000,1871.764371],[1770681600000,1838.549723],[1770768000000,1823.73666],[1770854400000,1807.094894],[1770940800000,1869.608922],[1771027200000,1854.440531],[1771113600000,1805.347309],[1771200000000,1808.190518],[1771286400000,1806.694088],[1771372800000,1837.839906],[1771459200000,1845.951296],[1771545600000,1865.359086],[1771632000000,1854.460271],[1771718400000,1838.960097],[1771804800000,1900.0]],"market_caps":[[1764028800000,473471854765.0],[1764115200000,481740567406.0],[1764201600000,475479491432.0],[1764288000000,477813426525.0],[1764374400000,491151192088.0],[1764460800000,489912934733.0],[1764547200000,482428583638.0],[1764633600000,474971477916.0],[1764720000000,489257841886.0],[1764806400000,466691392725.0],[1764892800000,457129040698.0],[1764979200000,462618147663.0],[1765065600000,459512129958.0],[1765152000000,440243488323.0],[1765238400000,438810509893.0],[1765324800000,447243041131.0],[1765411200000,451700131288.0],[1765497600000,445721817414.0],[1765584000000,446768325003.0],[1765670400000,421977476744.0],[1765756800000,404110687276.0],[1765843200000,409789426162.0],[1765929600000,394815863388.0],[1766016000000,370226558319.0],[1766102400000,355415539033.0],[1766188800000,339834218233.0],[1766275200000,342176974140.0],[1766361600000,319630920247.0],[1766448000000,310328638095.0],[1766534400000,299598777238.0],[1766620800000,295821376191.0],[1766707200000,308744632160.0],[1766793600000,309503641397.0],[1766880000000,304292234132.0],[1766966400000,297082720526.0],[1767052800000,296355432429.0],[1767139200000,305194100599.0],[1767225600000,307488953317.0],[1767312000000,308245074114.0],[1767398400000,302748426041.0],[1767484800000,299007410529.0],[1767571200000,304070491266.0],[1767657600000,304804609715.0],[1767744000000,281727239466.0],[1767830400000,279604793328.0],[1767916800000,270836089338.0],[1768003200000,261949018736.0],[1768089600000,260743245667.0],[1768176000000,266625714179.0],[1768262400000,271413538714.0],[1768348800000,255482886433.0],[1768435200000,253530853679.0],[1768521600000,244530483880.0],[1768608000000,238720972242.0],[1768694400000,239301737254.0],[1768780800000,228821616932.0],[1768867200000,228984615694.0],[1768953600000,228165875800.0],[1769040000000,230916046683.0],[1769126400000,227955438139.0],[1769212800000,221899121860.0],[1769299200000,222484126661.0],[1769385600000,225397681550.0],[1769472000000,228998130018.0],[1769558400000,236961556223.0],[1769644800000,229782920102.0],[1769731200000,232147342182.0],[1769817600000,228578104896.0],[1769904000000,235178552226.0],[1769990400000,236572389441.0],[1770076800000,236786578318.0],[1770163200000,237539129600.0],[1770249600000,229288579978.0],[1770336000000,222155595267.0],[1770422400000,227557323195.0],[1770508800000,221039996732.0],[1770595200000,225596863689.0],[1770681600000,221593624522.0],[1770768000000,219808260559.0],[1770854400000,217802489811.0],[1770940800000,225337075335.0],[1771027200000,223508885032.0],[1771113600000,217591859865.0],[1771200000000,217934541392.0],[1771286400000,217754182236.0],[1771372800000,221508072825.0],[1771459200000,222485708787.0],[1771545600000,224824858221.0],[1771632000000,223511264277.0],[1771718400000,221643085411.0],[1771804800000,229000000000.0]]}},"nasdaq":[[1764028800000,111.2012],[1764115200000,110.6213],[1764201600000,109.0024],[1764288000000,108.6699],[1764374400000,107.4617],[1764460800000,107.4663],[1764547200000,106.6934],[1764633600000,104.1953],[1764720000000,100.2093],[1764806400000,101.1605],[1764892800000,100.9106],[1764979200000,100.7611],[1765065600000,98.4823],[1765152000000,99.8473],[1765238400000,97.4016],[1765324800000,99.3997],[1765411200000,99.0139],[1765497600000,97.3422],[1765584000000,98.9975],[1765670400000,98.2907],[1765756800000,99.4907],[1765843200000,99.0791],[1765929600000,97.93],[1766016000000,97.7821],[1766102400000,98.6133],[1766188800000,100.795],[1766275200000,100.4181],[1766361600000,98.9724],[1766448000000,98.6378],[1766534400000,97.3891],[1766620800000,98.0276],[1766707200000,98.1295],[1766793600000,97.5187],[1766880000000,97.354],[1766966400000,99.8933],[1767052800000,99.6823],[1767139200000,99.1416],[1767225600000,100.3645],[1767312000000,101.1539],[1767398400000,100.5461],[1767484800000,99.8143],[1767571200000,102.0007],[1767657600000,104.3396],[1767744000000,105.0326],[1767830400000,103.1852],[1767916800000,102.2802],[1768003200000,99.5596],[1768089600000,98.7153],[1768176000000,98.726],[1768262400000,97.0276],[1768348800000,97.0549],[1768435200000,98.036],[1768521600000,98.4229],[1768608000000,98.061],[1768694400000,96.8499],[1768780800000,96.6843],[1768867200000,98.3397],[1768953600000,99.1039],[1769040000000,97.8858],[1769126400000,100.6359],[1769212800000,99.1735],[1769299200000,99.4235],[1769385600000,98.3884],[1769472000000,96.9742],[1769558400000,97.5074],[1769644800000,100.2073],[1769731200000,99.478],[1769817600000,101.0484],[1769904000000,100.1114],[1769990400000,97.9914],[1770076800000,96.8352],[1770163200000,97.6508],[1770249600000,97.0025],[1770336000000,96.9902],[1770422400000,96.4429],[1770508800000,95.5652],[1770595200000,94.1277],[1770681600000,93.7303],[1770768000000,94.308],[1770854400000,94.5731],[1770940800000,92.9157],[1771027200000,93.347],[1771113600000,95.1321],[1771200000000,94.2951],[1771286400000,93.8366],[1771372800000,92.4494],[1771459200000,96.5749],[1771545600000,95.2356],[1771632000000,95.9665],[1771718400000,97.5263],[1771804800000,100.0]]};

// ============================================================
// CONFIG & STATE
// ============================================================
let OTF_TOKENS = EMBEDDED_DATA.tokens.slice();
const BENCHMARKS = EMBEDDED_DATA.benchmarks;
const OTF_INDEX_COLOR = '#3164FA';
const NASDAQ_COLOR = '#E5484D';
const TOKEN_COLORS = ['#B6509E','#3B82F6','#FACC15','#06B6D4','#EC4899','#8B5CF6','#F97316','#14B8A6','#EF4444','#6366F1'];

let rawData = {};
let nasdaqData = [];
let currentRange = 90;
let activeLines = { otf: true, nasdaq: true, btc: true, eth: true };
let tokenActiveState = {};
let mainChart = null;
let barChart = null;
let miniCharts = {};

// Initialize all tokens as active
OTF_TOKENS.forEach(t => { tokenActiveState[t.cgId] = true; });

function getActiveTokens() {
  return OTF_TOKENS.filter(t => tokenActiveState[t.cgId]);
}

// ============================================================
// DATA LOADING
// ============================================================
async function fetchTokenHistory(cgId, days) {
  const d = days === 0 ? 'max' : days;
  const url = `https://api.coingecko.com/api/v3/coins/${cgId}/market_chart?vs_currency=usd&days=${d}&interval=daily`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

async function tryLiveFetch(days) {
  const allIds = [...OTF_TOKENS, ...BENCHMARKS];
  const results = {};
  for (const token of allIds) {
    try {
      const data = await fetchTokenHistory(token.cgId, days);
      if (data && data.prices && data.prices.length > 0) {
        results[token.cgId] = data;
      } else { throw new Error('Empty'); }
    } catch (e) { return null; }
    await new Promise(r => setTimeout(r, 350));
  }
  return results;
}

async function loadData(days) {
  try {
    const live = await tryLiveFetch(days);
    if (live && Object.keys(live).length >= (OTF_TOKENS.length + BENCHMARKS.length)) {
      rawData = live;
      nasdaqData = generateNasdaqProxy(getAlignedDates(rawData));
      setStatus('live');
      return;
    }
  } catch(e) {}

  // Fallback to embedded
  const embedded = EMBEDDED_DATA.data;
  rawData = {};
  for (const key in embedded) {
    const d = embedded[key];
    const total = d.prices.length;
    const from = days > 0 ? Math.max(0, total - days) : 0;
    rawData[key] = { prices: d.prices.slice(from), market_caps: d.market_caps.slice(from) };
  }
  const allN = EMBEDDED_DATA.nasdaq;
  const fromN = days > 0 ? Math.max(0, allN.length - days) : 0;
  nasdaqData = allN.slice(fromN);
  setStatus('sample');
}

function setStatus(mode) {
  const badge = document.getElementById('statusBadge');
  const text = document.getElementById('statusText');
  const note = document.getElementById('dataNote');
  const noteText = document.getElementById('dataNoteText');
  if (mode === 'live') {
    badge.style.cssText = 'display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;background:rgba(0,179,125,0.08);color:#00855E;border:1px solid rgba(0,179,125,0.2)';
    badge.querySelector('.status-dot').style.background = '#00B37D';
    text.textContent = 'Live Data';
    note.style.display = 'none';
  } else {
    badge.style.cssText = 'display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;background:rgba(245,158,11,0.08);color:#B45309;border:1px solid rgba(245,158,11,0.2)';
    badge.querySelector('.status-dot').style.background = '#F59E0B';
    text.textContent = 'Sample Data';
    note.style.display = 'flex';
    noteText.innerHTML = 'Showing sample data (Feb 2026 snapshot). Live CoinGecko data loads automatically when deployed.';
  }
}

// ============================================================
// DATA PROCESSING
// ============================================================
function getAlignedDates(data) {
  const allDates = {};
  for (const cgId in data) {
    if (data[cgId] && data[cgId].prices) {
      data[cgId].prices.forEach(([ts]) => {
        const day = new Date(ts).toISOString().split('T')[0];
        allDates[day] = (allDates[day] || 0) + 1;
      });
    }
  }
  return Object.keys(allDates).sort();
}

function getPriceByDate(prices, dateStr) {
  if (!prices) return null;
  for (const [ts, p] of prices) {
    if (new Date(ts).toISOString().split('T')[0] === dateStr) return p;
  }
  return null;
}

function getMcapByDate(mcaps, dateStr) {
  if (!mcaps) return null;
  for (const [ts, m] of mcaps) {
    if (new Date(ts).toISOString().split('T')[0] === dateStr) return m;
  }
  return null;
}

function computeOtfIndex(data, dates) {
  const active = getActiveTokens();
  if (active.length === 0) return dates.map(() => null);
  const vals = [];
  let base = null;
  for (const date of dates) {
    let ok = true;
    const td = active.map(t => {
      const d = data[t.cgId];
      if (!d) { ok = false; return null; }
      const price = getPriceByDate(d.prices, date);
      const mcap = getMcapByDate(d.market_caps, date);
      if (!price || !mcap) { ok = false; return null; }
      return { price, mcap };
    });
    if (!ok) { vals.push(null); continue; }
    const total = td.reduce((s, t) => s + t.mcap, 0);
    if (!base) { base = total; vals.push(100); }
    else { vals.push((total / base) * 100); }
  }
  return vals;
}

function normalizeToHundred(prices, dates) {
  if (!prices) return dates.map(() => null);
  const vals = dates.map(d => getPriceByDate(prices, d));
  const first = vals.find(v => v !== null);
  if (!first) return vals;
  return vals.map(v => v !== null ? (v / first) * 100 : null);
}

function getNasdaqNormalized(dates) {
  if (!nasdaqData || nasdaqData.length === 0) return dates.map(() => null);
  const byDate = {};
  nasdaqData.forEach(([ts, val]) => { byDate[new Date(ts).toISOString().split('T')[0]] = val; });
  const vals = dates.map(d => byDate[d] || null);
  const first = vals.find(v => v !== null);
  if (!first) return vals;
  return vals.map(v => v !== null ? (v / first) * 100 : null);
}

function generateNasdaqProxy(dates) {
  let val = 100, rng = 42; const values = [];
  for (let i = 0; i < dates.length; i++) {
    rng = (rng * 16807) % 2147483647;
    val *= (1 + ((rng % 1000) / 1000 - 0.48) * 0.015);
    values.push([new Date(dates[i]).getTime(), val]);
  }
  return values;
}

// ============================================================
// CHARTS
// ============================================================
function renderMainChart(dates, datasets) {
  const ctx = document.getElementById('mainChart').getContext('2d');
  if (mainChart) mainChart.destroy();
  const filtered = datasets.filter(ds => activeLines[ds.id]);

  mainChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
      datasets: filtered.map(ds => ({
        label: ds.label, data: ds.data,
        borderColor: ds.color, backgroundColor: ds.color + '12',
        borderWidth: ds.id === 'otf' ? 3 : 2,
        pointRadius: 0, pointHoverRadius: 5, tension: 0.3,
        fill: ds.id === 'otf', spanGaps: true,
      })),
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          display: true, position: 'top',
          labels: { color: '#0B1A3E', usePointStyle: true, pointStyle: 'circle', padding: 20, font: { size: 12, weight: '600' } },
        },
        tooltip: {
          backgroundColor: '#0B1A3E', titleColor: '#fff', bodyColor: '#CBD5E1',
          borderColor: '#1e3a5f', borderWidth: 1, padding: 12, displayColors: true,
          callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y?.toFixed(2)}` },
        },
      },
      scales: {
        x: { grid: { color: '#E8EDF5' }, ticks: { color: '#7889A5', maxTicksLimit: 12, font: { size: 11 } } },
        y: { grid: { color: '#E8EDF5' }, ticks: { color: '#7889A5', font: { size: 11 }, callback: v => v.toFixed(0) } },
      },
    },
  });
}

function renderBarChart(tokenPerf) {
  const ctx = document.getElementById('tokenBarChart').getContext('2d');
  if (barChart) barChart.destroy();
  const sorted = [...tokenPerf].sort((a, b) => b.change - a.change);
  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(t => t.symbol),
      datasets: [{
        data: sorted.map(t => t.change),
        backgroundColor: sorted.map(t => t.change >= 0 ? '#00B37D30' : '#E5484D30'),
        borderColor: sorted.map(t => t.change >= 0 ? '#00B37D' : '#E5484D'),
        borderWidth: 2, borderRadius: 6,
      }],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0B1A3E', titleColor: '#fff', bodyColor: '#CBD5E1',
          callbacks: { label: c => `${c.parsed.y >= 0 ? '+' : ''}${c.parsed.y.toFixed(2)}%` },
        },
      },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#4A5B7A', font: { size: 13, weight: '600' } } },
        y: { grid: { color: '#E8EDF5' }, ticks: { color: '#7889A5', callback: v => `${v >= 0 ? '+' : ''}${v}%` } },
      },
    },
  });
}

// ============================================================
// UI RENDERING
// ============================================================
function renderSummaryCards(otfIdx, nasdaqN, btcN, ethN) {
  const last = arr => arr.filter(v => v !== null).slice(-1)[0] || 0;
  const first = arr => arr.find(v => v !== null) || 100;
  const pct = arr => ((last(arr) - first(arr)) / first(arr) * 100);

  document.getElementById('indexValue').textContent = last(otfIdx).toFixed(2);
  setChange('indexChange', pct(otfIdx));
  document.getElementById('nasdaqValue').textContent = last(nasdaqN).toFixed(2);
  setChange('nasdaqChange', pct(nasdaqN));
  document.getElementById('btcValue').textContent = last(btcN).toFixed(2);
  setChange('btcChange', pct(btcN));
  document.getElementById('ethValue').textContent = last(ethN).toFixed(2);
  setChange('ethChange', pct(ethN));
}

function setChange(id, val) {
  const el = document.getElementById(id);
  el.textContent = `${val >= 0 ? '+' : ''}${val.toFixed(2)}%`;
  el.className = `summary-change ${val >= 0 ? 'positive' : 'negative'}`;
}

function renderTokenCards(data, dates) {
  const grid = document.getElementById('tokenGrid');
  grid.innerHTML = '';
  Object.values(miniCharts).forEach(c => c.destroy());
  miniCharts = {};

  getActiveTokens().forEach(token => {
    const d = data[token.cgId];
    if (!d) return;
    const prices = dates.map(dt => getPriceByDate(d.prices, dt)).filter(v => v !== null);
    const mcaps = dates.map(dt => getMcapByDate(d.market_caps, dt)).filter(v => v !== null);
    const curr = prices[prices.length - 1] || 0;
    const first = prices[0] || 1;
    const change = ((curr - first) / first * 100);
    const mcap = mcaps[mcaps.length - 1] || 0;

    const card = document.createElement('div');
    card.className = 'token-card';
    card.innerHTML = `
      <div class="token-top">
        <div class="token-info">
          <div class="token-icon" style="background:${token.color}">${token.symbol[0]}</div>
          <div>
            <div class="token-name">${token.symbol}</div>
            <div class="token-fullname">${token.name}</div>
          </div>
        </div>
        <div>
          <div class="token-price">$${curr >= 1 ? curr.toFixed(2) : curr.toFixed(4)}</div>
          <div class="summary-change ${change >= 0 ? 'positive' : 'negative'}" style="float:right;margin-top:4px;">
            ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
          </div>
        </div>
      </div>
      <div class="mini-chart"><canvas id="mini-${token.symbol}"></canvas></div>
      <div class="token-metrics">
        <div><div class="metric-label">Market Cap</div><div class="metric-value">$${formatNumber(mcap)}</div></div>
        <div><div class="metric-label">Period Change</div><div class="metric-value ${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div></div>
      </div>
    `;
    grid.appendChild(card);

    setTimeout(() => {
      const el = document.getElementById(`mini-${token.symbol}`);
      if (el) {
        miniCharts[token.symbol] = new Chart(el.getContext('2d'), {
          type: 'line',
          data: {
            labels: prices.map((_, i) => i),
            datasets: [{ data: prices,
              borderColor: change >= 0 ? '#00B37D' : '#E5484D',
              backgroundColor: (change >= 0 ? '#00B37D' : '#E5484D') + '12',
              borderWidth: 2, pointRadius: 0, tension: 0.4, fill: true,
            }],
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            scales: { x: { display: false }, y: { display: false } },
          },
        });
      }
    }, 50);
  });
}

function renderAllocation(data, dates) {
  const lastDate = dates[dates.length - 1];
  const active = getActiveTokens();
  const mcaps = active.map(token => {
    const d = data[token.cgId];
    return { ...token, mcap: d ? (getMcapByDate(d.market_caps, lastDate) || 0) : 0 };
  });
  const total = mcaps.reduce((s, t) => s + t.mcap, 0);
  const bar = document.getElementById('allocBar');
  const legend = document.getElementById('allocLegend');
  bar.innerHTML = ''; legend.innerHTML = '';

  mcaps.sort((a, b) => b.mcap - a.mcap).forEach(t => {
    const pct = total > 0 ? (t.mcap / total * 100) : 0;
    const seg = document.createElement('div');
    seg.className = 'alloc-segment';
    seg.style.width = `${pct}%`; seg.style.background = t.color;
    seg.textContent = pct > 5 ? `${pct.toFixed(0)}%` : '';
    seg.title = `${t.symbol}: ${pct.toFixed(1)}%`;
    bar.appendChild(seg);

    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<div class="legend-dot" style="background:${t.color}"></div>
      <span>${t.symbol}</span><span class="legend-pct">${pct.toFixed(1)}%</span>
      <span style="color:var(--text-muted)">($${formatNumber(t.mcap)})</span>`;
    legend.appendChild(item);
  });
}

function renderToggles() {
  const c = document.getElementById('chartToggles');
  const items = [
    { id: 'otf', label: 'OTF Index', color: OTF_INDEX_COLOR },
    { id: 'nasdaq', label: 'NASDAQ', color: NASDAQ_COLOR },
    { id: 'btc', label: 'Bitcoin', color: '#F7931A' },
    { id: 'eth', label: 'Ethereum', color: '#627EEA' },
  ];
  c.innerHTML = items.map(i => `
    <button class="toggle-btn ${activeLines[i.id] ? 'active' : ''}" data-line="${i.id}">
      <div class="toggle-dot" style="background:${i.color}"></div>${i.label}
    </button>`).join('');
  c.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      activeLines[btn.dataset.line] = !activeLines[btn.dataset.line];
      btn.classList.toggle('active');
      updateCharts();
    });
  });
}

// ============================================================
// TOKEN MANAGEMENT
// ============================================================
function renderTokenMgmt() {
  const grid = document.getElementById('tokenMgmtGrid');
  grid.innerHTML = '';
  OTF_TOKENS.forEach(token => {
    const isActive = tokenActiveState[token.cgId];
    const item = document.createElement('div');
    item.className = `token-toggle-item ${isActive ? '' : 'inactive'}`;
    item.innerHTML = `
      <div class="toggle-switch ${isActive ? 'active' : ''}" data-cgid="${token.cgId}"></div>
      <div>
        <div class="token-toggle-label">${token.symbol}</div>
        <div class="token-toggle-sub">${token.name}</div>
      </div>`;
    const sw = item.querySelector('.toggle-switch');
    sw.addEventListener('click', () => {
      tokenActiveState[token.cgId] = !tokenActiveState[token.cgId];
      renderTokenMgmt();
      updateCharts();
    });
    grid.appendChild(item);
  });
}

async function handleAddToken() {
  const cgId = document.getElementById('newCgId').value.trim();
  const symbol = document.getElementById('newSymbol').value.trim().toUpperCase();
  const name = document.getElementById('newName').value.trim();
  const status = document.getElementById('formStatus');

  if (!cgId || !symbol || !name) {
    status.className = 'form-status'; status.style.display = 'block';
    status.style.color = '#CD2B31'; status.style.background = 'rgba(229,72,77,0.08)';
    status.textContent = 'All fields are required.'; return;
  }
  if (OTF_TOKENS.find(t => t.cgId === cgId)) {
    status.className = 'form-status'; status.style.display = 'block';
    status.style.color = '#CD2B31'; status.style.background = 'rgba(229,72,77,0.08)';
    status.textContent = 'Token already exists.'; return;
  }

  status.className = 'form-status'; status.style.display = 'block';
  status.style.color = '#7889A5'; status.style.background = 'rgba(49,100,250,0.05)';
  status.textContent = 'Fetching data from CoinGecko...';

  const color = TOKEN_COLORS[OTF_TOKENS.length % TOKEN_COLORS.length];
  const newToken = { symbol, name, cgId, color };

  try {
    const data = await fetchTokenHistory(cgId, currentRange);
    if (data && data.prices && data.prices.length > 0) {
      rawData[cgId] = data;
    } else { throw new Error('No data'); }
  } catch(e) {
    // Still add token, just note that data will load when deployed
    status.textContent = 'Token added (data will load when deployed to a server).';
    status.style.color = '#B45309'; status.style.background = 'rgba(245,158,11,0.08)';
  }

  OTF_TOKENS.push(newToken);
  tokenActiveState[cgId] = true;

  status.style.color = '#00855E'; status.style.background = 'rgba(0,179,125,0.08)';
  status.textContent = `${symbol} added to index!`;

  document.getElementById('newCgId').value = '';
  document.getElementById('newSymbol').value = '';
  document.getElementById('newName').value = '';

  renderTokenMgmt();
  updateCharts();

  setTimeout(() => {
    document.getElementById('addTokenForm').classList.remove('visible');
    status.style.display = 'none';
  }, 2000);
}

// ============================================================
// HELPERS
// ============================================================
function formatNumber(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toFixed(0);
}

// ============================================================
// MAIN UPDATE
// ============================================================
function updateCharts() {
  if (Object.keys(rawData).length === 0) return;
  const dates = getAlignedDates(rawData);
  if (dates.length === 0) return;

  const otfIdx = computeOtfIndex(rawData, dates);
  const btcN = normalizeToHundred(rawData['bitcoin']?.prices, dates);
  const ethN = normalizeToHundred(rawData['ethereum']?.prices, dates);
  const nasdaqN = getNasdaqNormalized(dates);

  renderMainChart(dates, [
    { id: 'otf', label: 'OTF Index', data: otfIdx, color: OTF_INDEX_COLOR },
    { id: 'nasdaq', label: 'NASDAQ (sim)', data: nasdaqN, color: NASDAQ_COLOR },
    { id: 'btc', label: 'Bitcoin', data: btcN, color: '#F7931A' },
    { id: 'eth', label: 'Ethereum', data: ethN, color: '#627EEA' },
  ]);

  renderSummaryCards(otfIdx, nasdaqN, btcN, ethN);
  renderTokenCards(rawData, dates);
  renderAllocation(rawData, dates);

  const active = getActiveTokens();
  const perf = active.map(token => {
    const d = rawData[token.cgId];
    if (!d) return { ...token, change: 0 };
    const prices = dates.map(dt => getPriceByDate(d.prices, dt)).filter(v => v !== null);
    const change = prices.length >= 2 ? ((prices[prices.length-1] - prices[0]) / prices[0] * 100) : 0;
    return { ...token, change };
  });
  renderBarChart(perf);
}

// ============================================================
// INIT
// ============================================================
async function init() {
  document.getElementById('lastUpdated').textContent = `Updated: ${new Date().toLocaleString()}`;
  renderToggles();
  renderTokenMgmt();

  // Time range buttons
  document.querySelectorAll('.time-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentRange = parseInt(btn.dataset.range);
      document.getElementById('indexValue').textContent = 'Loading...';
      await loadData(currentRange);
      updateCharts();
    });
  });

  // Token management collapse
  document.getElementById('mgmtCollapseBtn').addEventListener('click', () => {
    const body = document.getElementById('mgmtBody');
    const btn = document.getElementById('mgmtCollapseBtn');
    body.classList.toggle('collapsed');
    btn.innerHTML = body.classList.contains('collapsed') ? '+' : '&#8722;';
  });

  // Add token form
  document.getElementById('addTokenBtn').addEventListener('click', () => {
    document.getElementById('addTokenForm').classList.toggle('visible');
  });
  document.getElementById('cancelTokenBtn').addEventListener('click', () => {
    document.getElementById('addTokenForm').classList.remove('visible');
  });
  document.getElementById('submitTokenBtn').addEventListener('click', handleAddToken);

  // Load data
  document.getElementById('indexValue').textContent = 'Loading...';
  await loadData(currentRange);
  updateCharts();
}

init();
</script>
</body>
</html>
